<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Puzzle Game</title>
    
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../flowRenderer/flow_pieces_and_tray.css">
    <link rel="stylesheet" href="../flowRenderer/flow_canvas.css">
    <link rel="stylesheet" href="./game_controls.css">
    <link rel="stylesheet" href="./gameLayout.css">

    <link rel="stylesheet" href="./gameFlowRenderer.css">
    <link rel="stylesheet" href="./zoom.css">
    <link rel="stylesheet" href="./toast.css">
    <link rel="stylesheet" href="./customDropdown.css">

    <link rel="icon" type="image/png" href="/favicon.png">
</head>
<body class="flow-app-base">

<header id="game-controls" class="game-controls-cards">
    <div class="game-controls-top">
        <a href="/" class="home-link">
            <img src="/favicon.png" alt="Accueil" class="home-logo">
        </a>
        <div class="puzzle-controls-row">
            <h3 class="controls-title puzzle-controls-title">Select Puzzle</h3>
            <div class="how-to-play puzzle-controls-howto">
                How to play: <span>Start with <b>Events (orange)</b>, then add <b>Screens</b> and <b>Automation</b>, then <b>Commands (blue)</b> and <b>Readmodels (green)</b> to complete the flow.</span>
            </div>
        </div>
    </div>

        <div class="game-cards-dropdown-row">
            <label for="custom-game-dropdown" style="font-weight:600;margin-right:0.5em;">Choose Puzzle:</label>
            <div id="custom-game-dropdown" class="custom-dropdown" tabindex="0"></div>
        </div>
</header>


<div id="app" class="app-layout">
    <main class="main-content">
        <section id="piece-tray" class="piece-tray-styles">
            <div class="piece-header-row">
                <h2 class="piece-header-title"><span id="available-pieces-label" style="font-weight: bold;">Available Pieces:</span> <span id="game-description" style="font-weight: normal;"></span></h2>
            </div>
            <div id="tray-canvas" class="tray-canvas-wrapper">
                <div class="tray-controls-wrapper" style="position: relative; top: -15px;">
                    <div class="zoom-controls" id="tray-zoom-controls">
                        <button id="tray-zoom-out">‚àí</button>
                        <button id="tray-zoom-reset">‚ü≥</button>
                        <button id="tray-zoom-in">+</button>
                        <button id="help-btn" title="Show misplaced cards">Help</button>
                        <button id="bin-btn" title="Clear this game's progress">üóëÔ∏è</button>
                    </div>
                </div>
                <div id="tray-inner"></div>
            </div>
        </section>

        <section id="flow-area" class="flow-area-styles">
            <div class="zoom-controls">
                <button id="zoom-out">‚àí</button>
                <button id="zoom-reset">‚ü≥</button>
                <button id="zoom-in">+</button>
            </div>
            <div id="flow-canvas" class="flow-canvas-wrapper">
                <div id="flow-inner">
                    <div id="grid-container"></div>
                    <svg id="flow-svg"></svg>
                </div>
            </div>
        </section>
    </main>
</div>

<script type="module" src="gameLoader.js"></script>
<script type="module" src="puzzleGuide.js"></script> 
<script type="module" src="../flowRenderer/flowRenderer.js"></script>

<script src="./tray-zoom.js"></script>

<script>
(function() {
    const flowInner = document.getElementById('flow-inner');
    const zoomIn = document.getElementById('zoom-in');
    const zoomOut = document.getElementById('zoom-out');
    const zoomReset = document.getElementById('zoom-reset');
    const minZoom = 0.5;
    const maxZoom = 2.0;
    const step = 0.1;
    let zoomLevel = 1;

    function applyZoom() {
        flowInner.style.transform = `scale(${zoomLevel})`;
    }

    zoomIn.addEventListener('click', () => {
        zoomLevel = Math.min(maxZoom, zoomLevel + step);
        applyZoom();
    });

    zoomOut.addEventListener('click', () => {
        zoomLevel = Math.max(minZoom, zoomLevel - step);
        applyZoom();
    });

    zoomReset.addEventListener('click', () => {
        zoomLevel = 1;
        applyZoom();
    });

    document.getElementById('flow-area').addEventListener('wheel', (e) => {
        if (!e.ctrlKey) return;
        e.preventDefault();
        zoomLevel += e.deltaY > 0 ? -step : step;
        zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel));
        applyZoom();
    }, { passive: false });

    // Bin button logic
    const binBtn = document.getElementById('bin-btn');
    binBtn?.addEventListener('click', () => {
        if (typeof window.resetCurrentGameBoard === 'function') {
            window.resetCurrentGameBoard();
        }
    });

    applyZoom();
})();
</script>

</body>
</html>